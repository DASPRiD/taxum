---
description: Assign request IDs to incoming requests and propagate them to outgoing responses. 
---

# Request ID Middleware

The request ID middleware ensures that every incoming HTTP request is associated with a unique identifier. This ID can
either be provided by the client via a header or automatically generated by the server. Propagating this ID to the
response allows for consistent request tracing across your system.

## Layers

### `SetRequestIdLayer`

This layer manages the creation or assignment of a request ID for each incoming request.

- Header used: `X-Request-Id` by default
- ID generation: By default, a UUID is generated using Node's `crypto.randomUUID()`

```ts
import { SetRequestIdLayer } from "@taxum/core/middleware/request-id";
import { m, Router } from "@taxum/core/routing";

const router = new Router()
    .route("/", m.get(() => "Hello World"))
    .layer(SetRequestIdLayer.default());
```

::: tip NOTE

You can also provide a custom header name or a custom function to generate request IDs.

:::

### `SetRequestIdLayer`

This layer ensures that the request ID from the incoming request is propagated to the outgoing response. If the response
already includes a request ID header, it will use that; otherwise, it inserts the ID from the request.

```ts
import { PropagateRequestIdLayer } from "@taxum/core/middleware/request-id";
import { m, Router } from "@taxum/core/routing";

const router = new Router()
    .route("/", m.get(() => "Hello World"))
    .layer(PropagateRequestIdLayer.default());
```

## Retrieving the Request ID in a Handler

The request ID is stored in the request's extensions under the `REQUEST_ID` key. You can use this to log, trace, or pass
along to other services.

```ts
import { REQUEST_ID } from "@taxum/core/middleware/request-id";
import { m, Router } from "@taxum/core/routing";

const router = new Router()
    .route("/debug", m.get((req) => {
        const requestId = req.extensions.get(REQUEST_ID);
        return `Your request ID is: ${requestId}`;
    }))
    .layer(SetRequestIdLayer.default())
    .layer(PropagateRequestIdLayer.default());
```

## Usage Notes

1. **Order Matters**: `SetRequestIdLayer` should be applied before `PropagateRequestIdLayer` to ensure that a request ID
  exists for propagation.
2. **Custom IDs**: You can override the default UUID generator with your own function.
3. **Extensions**: The request ID is also stored in the request and response extensions under the `REQUEST_ID` key,
  making it easily accessible to other layers or handlers.

